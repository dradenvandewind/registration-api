\doxysection{activation\+\_\+service.\+py}
\label{activation__service_8py_source}\index{app/services/activation\_service.py@{app/services/activation\_service.py}}

\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{keyword}{from}\ app.db.repositories.activation\_repository\ \textcolor{keyword}{import}\ ActivationRepository}
\DoxyCodeLine{00002\ \textcolor{keyword}{from}\ app.db.repositories.user\_repository\ \textcolor{keyword}{import}\ UserRepository}
\DoxyCodeLine{00003\ \textcolor{keyword}{from}\ app.models.activation\ \textcolor{keyword}{import}\ ActivationCodeCreate}
\DoxyCodeLine{00004\ \textcolor{keyword}{from}\ app.core.security\ \textcolor{keyword}{import}\ generate\_activation\_code}
\DoxyCodeLine{00005\ \textcolor{keyword}{from}\ app.core.config\ \textcolor{keyword}{import}\ settings}
\DoxyCodeLine{00006\ \textcolor{keyword}{from}\ app.core.exceptions\ \textcolor{keyword}{import}\ (}
\DoxyCodeLine{00007\ \ \ \ \ InvalidActivationCodeError,\ }
\DoxyCodeLine{00008\ \ \ \ \ UserNotFoundError,}
\DoxyCodeLine{00009\ \ \ \ \ UserAlreadyActiveError}
\DoxyCodeLine{00010\ )}
\DoxyCodeLine{00011\ \textcolor{keyword}{from}\ datetime\ \textcolor{keyword}{import}\ datetime,\ timedelta}
\DoxyCodeLine{00012\ \textcolor{keyword}{from}\ uuid\ \textcolor{keyword}{import}\ UUID}
\DoxyCodeLine{00013\ }
\DoxyCodeLine{00014\ \textcolor{keyword}{import}\ logging}
\DoxyCodeLine{00015\ }
\DoxyCodeLine{00016\ logger\ =\ logging.getLogger(\_\_name\_\_)}
\DoxyCodeLine{00017\ }
\DoxyCodeLine{00018\ \textcolor{keyword}{class\ }ActivationService:}
\DoxyCodeLine{00019\ \ \ \ \ \textcolor{keyword}{def\ }\_\_init\_\_(self):}
\DoxyCodeLine{00020\ \ \ \ \ \ \ \ \ self.activation\_repo\ =\ ActivationRepository()}
\DoxyCodeLine{00021\ \ \ \ \ \ \ \ \ self.user\_repo\ =\ UserRepository()}
\DoxyCodeLine{00022\ }
\DoxyCodeLine{00023\ \ \ \ \ \textcolor{keyword}{async\ def\ }create\_activation\_code(self,\ user\_id:\ int)\ -\/>\ ActivationCodeCreate:}
\DoxyCodeLine{00024\ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}}}
\DoxyCodeLine{00025\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ Creates\ an\ activation\ code\ for\ a\ user}}
\DoxyCodeLine{00026\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ }}
\DoxyCodeLine{00027\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ Args:}}
\DoxyCodeLine{00028\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ \ \ \ \ user\_id:\ User\ ID}}
\DoxyCodeLine{00029\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ \ \ \ \ }}
\DoxyCodeLine{00030\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ Returns:}}
\DoxyCodeLine{00031\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ \ \ \ \ ActivationCode:\ The\ created\ activation\ code}}
\DoxyCodeLine{00032\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ "{}"{}"{}}}
\DoxyCodeLine{00033\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{try}:}
\DoxyCodeLine{00034\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Generate\ a\ 6-\/character\ code\ (to\ match\ the\ database)}}
\DoxyCodeLine{00035\ \ \ \ \ \ \ \ \ \ \ \ \ code\ =\ generate\_activation\_code(length=6)\ \ \textcolor{comment}{\#\ Force\ length\ to\ 6}}
\DoxyCodeLine{00036\ \ \ \ \ \ \ \ \ \ \ \ \ logger.info(f\textcolor{stringliteral}{"{}Activation\ code\ generated\ for\ user\ \{user\_id\}:\ \{code\}"{}})}
\DoxyCodeLine{00037\ \ \ \ \ \ \ \ \ \ \ \ \ expires\_at\ =\ datetime.utcnow()\ +\ timedelta(hours=1)}
\DoxyCodeLine{00038\ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00039\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Create\ data\ object}}
\DoxyCodeLine{00040\ \ \ \ \ \ \ \ \ \ \ \ \ activation\_data\ =\ ActivationCodeCreate(}
\DoxyCodeLine{00041\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ user\_id=user\_id,}
\DoxyCodeLine{00042\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ code=code,}
\DoxyCodeLine{00043\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ expires\_at=expires\_at}
\DoxyCodeLine{00044\ \ \ \ \ \ \ \ \ \ \ \ \ )}
\DoxyCodeLine{00045\ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00046\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Save\ to\ database}}
\DoxyCodeLine{00047\ \ \ \ \ \ \ \ \ \ \ \ \ activation\_code\ =\ await\ self.activation\_repo.create(activation\_data)}
\DoxyCodeLine{00048\ \ \ \ \ \ \ \ \ \ \ \ \ logger.info(f\textcolor{stringliteral}{"{}Activation\ code\ saved\ with\ ID:\ \{activation\_code.id\}"{}})}
\DoxyCodeLine{00049\ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00050\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ activation\_code}
\DoxyCodeLine{00051\ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00052\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{except}\ Exception\ \textcolor{keyword}{as}\ e:}
\DoxyCodeLine{00053\ \ \ \ \ \ \ \ \ \ \ \ \ logger.error(f\textcolor{stringliteral}{"{}Error\ creating\ activation\ code:\ \{e\}"{}})}
\DoxyCodeLine{00054\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{raise}}
\DoxyCodeLine{00055\ }
\DoxyCodeLine{00056\ \ \ \ \ \textcolor{keyword}{async\ def\ }activate\_user(self,\ user\_id:\ UUID,\ code:\ str)\ -\/>\ bool:}
\DoxyCodeLine{00057\ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}Activate\ user\ with\ code"{}"{}"{}}}
\DoxyCodeLine{00058\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Check\ if\ user\ exists}}
\DoxyCodeLine{00059\ \ \ \ \ \ \ \ \ user\ =\ await\ self.user\_repo.get\_by\_id(user\_id)}
\DoxyCodeLine{00060\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ \textcolor{keywordflow}{not}\ user:}
\DoxyCodeLine{00061\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{raise}\ UserNotFoundError(\textcolor{stringliteral}{"{}User\ not\ found"{}})}
\DoxyCodeLine{00062\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00063\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Check\ if\ already\ active}}
\DoxyCodeLine{00064\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ user.is\_active:}
\DoxyCodeLine{00065\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{raise}\ UserAlreadyActiveError(\textcolor{stringliteral}{"{}User\ is\ already\ active"{}})}
\DoxyCodeLine{00066\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00067\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Validate\ code}}
\DoxyCodeLine{00068\ \ \ \ \ \ \ \ \ valid\_code\ =\ await\ self.activation\_repo.get\_valid\_code(user\_id,\ code)}
\DoxyCodeLine{00069\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ \textcolor{keywordflow}{not}\ valid\_code:}
\DoxyCodeLine{00070\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{raise}\ InvalidActivationCodeError(\textcolor{stringliteral}{"{}Invalid\ or\ expired\ activation\ code"{}})}
\DoxyCodeLine{00071\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00072\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Mark\ code\ as\ used}}
\DoxyCodeLine{00073\ \ \ \ \ \ \ \ \ await\ self.activation\_repo.mark\_as\_used(valid\_code.id)}
\DoxyCodeLine{00074\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00075\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Activate\ user}}
\DoxyCodeLine{00076\ \ \ \ \ \ \ \ \ await\ self.user\_repo.activate\_user(user\_id)}
\DoxyCodeLine{00077\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00078\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{True}}

\end{DoxyCode}
