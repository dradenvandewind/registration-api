\doxysection{connection.\+py}
\label{connection_8py_source}\index{app/db/connection.py@{app/db/connection.py}}

\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{keyword}{import}\ asyncpg}
\DoxyCodeLine{00002\ \textcolor{keyword}{from}\ typing\ \textcolor{keyword}{import}\ Optional}
\DoxyCodeLine{00003\ \textcolor{keyword}{from}\ app.core.config\ \textcolor{keyword}{import}\ settings}
\DoxyCodeLine{00004\ }
\DoxyCodeLine{00005\ \textcolor{keyword}{class\ }DatabasePool:}
\DoxyCodeLine{00006\ \ \ \ \ \textcolor{keyword}{def\ }\_\_init\_\_(self):}
\DoxyCodeLine{00007\ \ \ \ \ \ \ \ \ self.pool:\ Optional[asyncpg.Pool]\ =\ \textcolor{keywordtype}{None}}
\DoxyCodeLine{00008\ \ \ \ \ \ \ \ \ self.\_initialized\ =\ \textcolor{keyword}{False}}
\DoxyCodeLine{00009\ }
\DoxyCodeLine{00010\ \ \ \ \ \textcolor{keyword}{async\ def\ }initialize(self):}
\DoxyCodeLine{00011\ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}Initialise\ le\ pool\ de\ connexions"{}"{}"{}}}
\DoxyCodeLine{00012\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ self.\_initialized:}
\DoxyCodeLine{00013\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}}
\DoxyCodeLine{00014\ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00015\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{try}:}
\DoxyCodeLine{00016\ \ \ \ \ \ \ \ \ \ \ \ \ self.pool\ =\ await\ asyncpg.create\_pool(}
\DoxyCodeLine{00017\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ settings.database\_url,}
\DoxyCodeLine{00018\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ min\_size=5,}
\DoxyCodeLine{00019\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ max\_size=20,}
\DoxyCodeLine{00020\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ command\_timeout=60}
\DoxyCodeLine{00021\ \ \ \ \ \ \ \ \ \ \ \ \ )}
\DoxyCodeLine{00022\ \ \ \ \ \ \ \ \ \ \ \ \ self.\_initialized\ =\ \textcolor{keyword}{True}}
\DoxyCodeLine{00023\ \ \ \ \ \ \ \ \ \ \ \ \ print(f\textcolor{stringliteral}{"{}✅\ Pool\ de\ connexions\ initialisé:\ \{settings.database\_url\}"{}})}
\DoxyCodeLine{00024\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{except}\ Exception\ \textcolor{keyword}{as}\ e:}
\DoxyCodeLine{00025\ \ \ \ \ \ \ \ \ \ \ \ \ print(f\textcolor{stringliteral}{"{}❌\ Erreur\ lors\ de\ l'initialisation\ du\ pool:\ \{e\}"{}})}
\DoxyCodeLine{00026\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{raise}}
\DoxyCodeLine{00027\ }
\DoxyCodeLine{00028\ \ \ \ \ \textcolor{keyword}{async\ def\ }close(self):}
\DoxyCodeLine{00029\ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}Ferme\ le\ pool\ de\ connexions"{}"{}"{}}}
\DoxyCodeLine{00030\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ self.pool:}
\DoxyCodeLine{00031\ \ \ \ \ \ \ \ \ \ \ \ \ await\ self.pool.close()}
\DoxyCodeLine{00032\ \ \ \ \ \ \ \ \ \ \ \ \ self.pool\ =\ \textcolor{keywordtype}{None}}
\DoxyCodeLine{00033\ \ \ \ \ \ \ \ \ \ \ \ \ self.\_initialized\ =\ \textcolor{keyword}{False}}
\DoxyCodeLine{00034\ \ \ \ \ \ \ \ \ \ \ \ \ print(\textcolor{stringliteral}{"{}✅\ Pool\ de\ connexions\ fermé"{}})}
\DoxyCodeLine{00035\ }
\DoxyCodeLine{00036\ \ \ \ \ \textcolor{keyword}{async\ def\ }execute(self,\ query:\ str,\ *args):}
\DoxyCodeLine{00037\ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}Exécute\ une\ requête\ sans\ retour\ de\ résultat"{}"{}"{}}}
\DoxyCodeLine{00038\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ \textcolor{keywordflow}{not}\ self.pool:}
\DoxyCodeLine{00039\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{raise}\ RuntimeError(\textcolor{stringliteral}{"{}Base\ de\ données\ non\ initialisée.\ Appelez\ initialize()\ d'abord."{}})}
\DoxyCodeLine{00040\ \ \ \ \ \ \ \ \ \textcolor{keyword}{async}\ \textcolor{keyword}{with}\ self.pool.acquire()\ \textcolor{keyword}{as}\ connection:}
\DoxyCodeLine{00041\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ await\ connection.execute(query,\ *args)}
\DoxyCodeLine{00042\ }
\DoxyCodeLine{00043\ \ \ \ \ \textcolor{keyword}{async\ def\ }fetch(self,\ query:\ str,\ *args):}
\DoxyCodeLine{00044\ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}Récupère\ plusieurs\ lignes"{}"{}"{}}}
\DoxyCodeLine{00045\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ \textcolor{keywordflow}{not}\ self.pool:}
\DoxyCodeLine{00046\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{raise}\ RuntimeError(\textcolor{stringliteral}{"{}Base\ de\ données\ non\ initialisée.\ Appelez\ initialize()\ d'abord."{}})}
\DoxyCodeLine{00047\ \ \ \ \ \ \ \ \ \textcolor{keyword}{async}\ \textcolor{keyword}{with}\ self.pool.acquire()\ \textcolor{keyword}{as}\ connection:}
\DoxyCodeLine{00048\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ await\ connection.fetch(query,\ *args)}
\DoxyCodeLine{00049\ }
\DoxyCodeLine{00050\ \ \ \ \ \textcolor{keyword}{async\ def\ }fetchrow(self,\ query:\ str,\ *args):}
\DoxyCodeLine{00051\ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}Récupère\ une\ seule\ ligne"{}"{}"{}}}
\DoxyCodeLine{00052\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ \textcolor{keywordflow}{not}\ self.pool:}
\DoxyCodeLine{00053\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{raise}\ RuntimeError(\textcolor{stringliteral}{"{}Base\ de\ données\ non\ initialisée.\ Appelez\ initialize()\ d'abord."{}})}
\DoxyCodeLine{00054\ \ \ \ \ \ \ \ \ \textcolor{keyword}{async}\ \textcolor{keyword}{with}\ self.pool.acquire()\ \textcolor{keyword}{as}\ connection:}
\DoxyCodeLine{00055\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ await\ connection.fetchrow(query,\ *args)}
\DoxyCodeLine{00056\ }
\DoxyCodeLine{00057\ db\ =\ DatabasePool()}

\end{DoxyCode}
